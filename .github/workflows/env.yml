name: Check ENV

on:
  push:
    branches: [action_env_test]

jobs:
  load-env:
    runs-on: ubuntu-latest
    steps:
      - name: Export env
        env:
          ENV_FILE_CONTENT: ${{ secrets.ENV_FILE_CONTENT }}
        run: |
          echo "$ENV_FILE_CONTENT" >> $GITHUB_ENV

      - name: Print env
        run: |
          echo =====
          echo 'Env from file:' $MY_ENV_1 $MY_ENV_2 $MY_ENV_3

  check-env:
    if: ${{ 1 == 2 }}
    runs-on: ubuntu-latest
    outputs:
      job_status: ${{ job.status }}
    env:
      JOB_ENV: this is env on job level
      JOB_ENV_RUN_ID: ${{ github.run_id }}
    steps:
      - name: Modify job env
        env:
          JOB_ENV: modified by step
        run: echo "done"

      - name: Print env
        env:
          STEP_ENV: this is env on step level
        run: |
          echo =====
          echo '$STEP_ENV=' $STEP_ENV
          echo 'env.STEP_ENV=' ${{ env.STEP_ENV }}
          echo =====
          echo '$JOB_ENV=' $JOB_ENV
          echo 'env.JOB_ENV=' ${{ env.JOB_ENV }}
          echo =====
          echo '$JOB_ENV_RUN_ID=' $JOB_ENV_RUN_ID
          echo 'env.JOB_ENV_RUN_ID=' ${{ env.JOB_ENV_RUN_ID }}
          exit 1

  check-env-2:
    runs-on: ubuntu-latest
    outputs:
      job_status: ${{ job.status }}
    steps:
      - name: Step 2
        run: echo OK

  check-env-3:
    if: always()
    runs-on: ubuntu-latest
    needs: [check-env, check-env-2]
    steps:
      - uses: actions/checkout@v2

      - name: Print previous job status
        env:
          CI_JOB_STATUS: '${{ needs.check-env.outputs.job_status }}${{ needs.check-env-2.outputs.job_status }}'
        run: |
          echo =====
          echo 'Previous job status: ' $CI_JOB_STATUS

  check-env-secret-1:
    runs-on: ubuntu-latest
    environment: Test
    steps:
      - name: Print environment secret
        env:
          AN_ENVIRONMENT_SECRET: ${{ secrets.AN_ENVIRONMENT_SECRET }}
        run: |
          echo =====
          echo 'AN_ENVIRONMENT_SECRET:' $AN_ENVIRONMENT_SECRET > test.txt
          cat test.txt

  check-env-secret-2:
    runs-on: ubuntu-latest
    environment: Staging
    steps:
      - name: Print environment secret
        env:
          AN_ENVIRONMENT_SECRET: ${{ secrets.AN_ENVIRONMENT_SECRET }}
        run: |
          echo =====
          echo 'AN_ENVIRONMENT_SECRET:' $AN_ENVIRONMENT_SECRET > test.txt
          cat test.txt
